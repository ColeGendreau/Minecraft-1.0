name: deploy

on:
  push:
    branches: [ main ]
    paths:
      - "apps/**"
      - "environments/**"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
      
      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group mc-demo-dev-rg \
            --name mc-demo-dev-aks \
            --admin \
            --overwrite-existing
      
      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.18.6'
      
      - name: Add Helm repositories
        run: |
          helm repo add itzg https://itzg.github.io/minecraft-server-charts/
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo add jetstack https://charts.jetstack.io
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update
      
      - name: Get infrastructure info from Azure
        id: infra
        run: |
          # Get the public IP address
          PUBLIC_IP=$(az network public-ip show \
            --resource-group MC_mc-demo-dev-rg_mc-demo-dev-aks_westus3 \
            --name mc-demo-dev-ingress-ip \
            --query ipAddress -o tsv)
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "âœ… Public IP: $PUBLIC_IP"
          
          # Get the node resource group name
          NODE_RG=$(az aks show \
            --resource-group mc-demo-dev-rg \
            --name mc-demo-dev-aks \
            --query nodeResourceGroup -o tsv)
          echo "node_rg=$NODE_RG" >> $GITHUB_OUTPUT
          echo "âœ… Node Resource Group: $NODE_RG"
      
      - name: Check for changes
        id: changes
        run: |
          git diff --name-only HEAD~1 HEAD > changed_files.txt
          cat changed_files.txt
          
          if grep -q "apps/minecraft/" changed_files.txt; then
            echo "minecraft=true" >> $GITHUB_OUTPUT
          fi
          if grep -q "apps/monitoring/" changed_files.txt; then
            echo "monitoring=true" >> $GITHUB_OUTPUT
          fi
          if grep -q "environments/ingress-values.yaml" changed_files.txt; then
            echo "ingress=true" >> $GITHUB_OUTPUT
          fi
          if grep -q "environments/cert-manager-values.yaml" changed_files.txt; then
            echo "certmanager=true" >> $GITHUB_OUTPUT
          fi
          if grep -q "apps/cert-manager/" changed_files.txt; then
            echo "certmanager_resources=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy Minecraft
        if: steps.changes.outputs.minecraft == 'true'
        run: |
          echo "ðŸš€ Deploying Minecraft..."
          helm upgrade minecraft itzg/minecraft \
            --install \
            --namespace minecraft \
            --create-namespace \
            --values apps/minecraft/values.yaml \
            --set minecraftServer.loadBalancerIP=${{ steps.infra.outputs.public_ip }} \
            --wait \
            --timeout 5m
          echo "âœ… Minecraft deployed successfully"
      
      - name: Deploy Monitoring
        if: steps.changes.outputs.monitoring == 'true'
        run: |
          echo "ðŸš€ Deploying Monitoring stack..."
          helm upgrade prometheus-community prometheus-community/kube-prometheus-stack \
            --install \
            --namespace monitoring \
            --create-namespace \
            --values apps/monitoring/values.yaml \
            --set grafana.ingress.hosts[0]=grafana.${{ steps.infra.outputs.public_ip }}.nip.io \
            --set grafana.ingress.tls[0].hosts[0]=grafana.${{ steps.infra.outputs.public_ip }}.nip.io \
            --wait \
            --timeout 10m
          echo "âœ… Monitoring stack deployed successfully"
      
      - name: Update Ingress
        if: steps.changes.outputs.ingress == 'true'
        run: |
          echo "ðŸš€ Updating Ingress..."
          helm upgrade ingress-nginx ingress-nginx/ingress-nginx \
            --install \
            --namespace ingress-nginx \
            --create-namespace \
            --values environments/ingress-values.yaml \
            --set controller.service.loadBalancerIP=${{ steps.infra.outputs.public_ip }} \
            --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-resource-group"=${{ steps.infra.outputs.node_rg }} \
            --wait \
            --timeout 5m
          echo "âœ… Ingress updated successfully"
      
      - name: Update cert-manager
        if: steps.changes.outputs.certmanager == 'true'
        run: |
          echo "ðŸš€ Updating cert-manager..."
          helm upgrade cert-manager jetstack/cert-manager \
            --install \
            --namespace cert-manager \
            --create-namespace \
            --values environments/cert-manager-values.yaml \
            --wait \
            --timeout 5m
          echo "âœ… cert-manager updated successfully"
      
      - name: Apply cert-manager resources
        if: steps.changes.outputs.certmanager_resources == 'true'
        run: |
          echo "ðŸš€ Applying cert-manager resources..."
          kubectl apply -f apps/cert-manager/cluster-issuer.yaml
          echo "âœ… cert-manager resources applied successfully"
      
      - name: Get deployment status
        run: |
          echo "=== Deployment Status ==="
          kubectl get pods -A | grep -E "NAMESPACE|minecraft|monitoring|ingress-nginx|cert-manager"
          echo ""
          echo "=== Services ==="
          kubectl get svc -A | grep LoadBalancer

