name: "3. Deploy Minecraft Apps"

on:
  push:
    branches: [ main ]
    paths:
      - "apps/**"
      - "environments/**"
  workflow_run:
    workflows: ["2. Minecraft Server"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Check infrastructure state
        id: check_state
        run: |
          STATE=$(cat INFRASTRUCTURE_STATE | tr -d '[:space:]' | tr '[:lower:]' '[:upper:]')
          echo "state=$STATE" >> $GITHUB_OUTPUT
          
          # If triggered by workflow_run, check if terraform workflow succeeded
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
              echo "Terraform workflow did not succeed - skipping deployment"
              exit 0
            fi
            if [ "$STATE" = "OFF" ]; then
              echo "Infrastructure is OFF - skipping deployment"
              exit 0
            fi
            echo "Terraform workflow succeeded and infrastructure is ON - deploying all applications"
          else
            if [ "$STATE" = "OFF" ]; then
              echo "Infrastructure is OFF - skipping deployment"
              exit 0
            fi
            echo "Infrastructure is ON - checking for application changes"
          fi
      
      - name: Azure login (OIDC)
        if: steps.check_state.outputs.state == 'ON'
        uses: azure/login@v2
        with:
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
      
      - name: Get AKS credentials
        if: steps.check_state.outputs.state == 'ON'
        run: |
          az aks get-credentials \
            --resource-group mc-demo-dev-rg \
            --name mc-demo-dev-aks \
            --admin \
            --overwrite-existing
      
      - name: Install Helm
        if: steps.check_state.outputs.state == 'ON'
        uses: azure/setup-helm@v4
        with:
          version: 'v3.18.6'
      
      - name: Add Helm repositories
        if: steps.check_state.outputs.state == 'ON'
        run: |
          helm repo add itzg https://itzg.github.io/minecraft-server-charts/
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo add jetstack https://charts.jetstack.io
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo update
      
      - name: Get infrastructure info from Azure
        if: steps.check_state.outputs.state == 'ON'
        id: infra
        run: |
          # Get the public IP address
          PUBLIC_IP=$(az network public-ip show \
            --resource-group MC_mc-demo-dev-rg_mc-demo-dev-aks_westus3 \
            --name mc-demo-dev-ingress-ip \
            --query ipAddress -o tsv)
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "âœ… Public IP: $PUBLIC_IP"
          
          # Get the node resource group name
          NODE_RG=$(az aks show \
            --resource-group mc-demo-dev-rg \
            --name mc-demo-dev-aks \
            --query nodeResourceGroup -o tsv)
          echo "node_rg=$NODE_RG" >> $GITHUB_OUTPUT
          echo "âœ… Node Resource Group: $NODE_RG"
      
      - name: Check for changes
        if: steps.check_state.outputs.state == 'ON'
        id: changes
        run: |
          # If triggered by workflow_run (after terraform) or workflow_dispatch (manual), deploy everything
          if [ "${{ github.event_name }}" = "workflow_run" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Full deployment triggered - deploying all applications"
            echo "minecraft=true" >> $GITHUB_OUTPUT
            echo "monitoring=true" >> $GITHUB_OUTPUT
            echo "ingress=true" >> $GITHUB_OUTPUT
            echo "certmanager=true" >> $GITHUB_OUTPUT
            echo "certmanager_resources=true" >> $GITHUB_OUTPUT
          else
            # For push events, check which files changed
            git diff --name-only HEAD~1 HEAD > changed_files.txt
            cat changed_files.txt
            
            if grep -q "apps/minecraft/" changed_files.txt; then
              echo "minecraft=true" >> $GITHUB_OUTPUT
            fi
            if grep -q "apps/monitoring/" changed_files.txt; then
              echo "monitoring=true" >> $GITHUB_OUTPUT
            fi
            if grep -q "environments/ingress-values.yaml" changed_files.txt; then
              echo "ingress=true" >> $GITHUB_OUTPUT
            fi
            if grep -q "environments/cert-manager-values.yaml" changed_files.txt; then
              echo "certmanager=true" >> $GITHUB_OUTPUT
            fi
            if grep -q "apps/cert-manager/" changed_files.txt; then
              echo "certmanager_resources=true" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Deploy Ingress Controller
        if: steps.changes.outputs.ingress == 'true'
        run: |
          echo "ðŸš€ Deploying NGINX Ingress Controller..."
          helm upgrade ingress-nginx ingress-nginx/ingress-nginx \
            --install \
            --namespace ingress-nginx \
            --create-namespace \
            --values environments/ingress-values.yaml \
            --set controller.service.loadBalancerIP=${{ steps.infra.outputs.public_ip }} \
            --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-resource-group"=${{ steps.infra.outputs.node_rg }} \
            --wait \
            --timeout 5m
          echo "âœ… Ingress Controller deployed successfully"
      
      - name: Deploy cert-manager
        if: steps.changes.outputs.certmanager == 'true'
        run: |
          echo "ðŸš€ Updating cert-manager..."
          helm upgrade cert-manager jetstack/cert-manager \
            --install \
            --namespace cert-manager \
            --create-namespace \
            --values environments/cert-manager-values.yaml \
            --wait \
            --timeout 5m
          echo "âœ… cert-manager updated successfully"
      
      - name: Apply cert-manager resources
        if: steps.changes.outputs.certmanager_resources == 'true'
        run: |
          echo "ðŸš€ Applying cert-manager resources..."
          kubectl apply -f apps/cert-manager/cluster-issuer.yaml
          echo "âœ… cert-manager resources applied successfully"
      
      - name: Deploy Minecraft Server
        if: steps.changes.outputs.minecraft == 'true'
        run: |
          echo "ðŸš€ Deploying Minecraft Server..."
          echo "Note: First deployment can take 8-10 minutes (downloading image + Java startup)"
          helm upgrade minecraft itzg/minecraft \
            --install \
            --namespace minecraft \
            --create-namespace \
            --values apps/minecraft/values.yaml \
            --set minecraftServer.loadBalancerIP=${{ steps.infra.outputs.public_ip }} \
            --wait \
            --timeout 12m
          echo "âœ… Minecraft deployed successfully"
      
      - name: Deploy Monitoring Stack
        if: steps.changes.outputs.monitoring == 'true'
        run: |
          echo "ðŸš€ Deploying Monitoring Stack (Prometheus/Grafana)..."
          helm upgrade prometheus-community prometheus-community/kube-prometheus-stack \
            --install \
            --namespace monitoring \
            --create-namespace \
            --values apps/monitoring/values.yaml \
            --set grafana.ingress.hosts[0]=grafana.${{ steps.infra.outputs.public_ip }}.nip.io \
            --set grafana.ingress.tls[0].hosts[0]=grafana.${{ steps.infra.outputs.public_ip }}.nip.io \
            --wait \
            --timeout 10m
          echo "âœ… Monitoring stack deployed successfully"
      
      - name: Get deployment status
        if: steps.check_state.outputs.state == 'ON'
        run: |
          echo "=== Deployment Status ==="
          kubectl get pods -A | grep -E "NAMESPACE|minecraft|monitoring|ingress-nginx|cert-manager"
          echo ""
          echo "=== Services ==="
          kubectl get svc -A | grep LoadBalancer

      - name: Update Coordinator with new credentials
        if: steps.check_state.outputs.state == 'ON'
        run: |
          echo "ðŸ”„ Updating Coordinator API with infrastructure credentials..."
          
          # Get Minecraft game server IP
          GAME_IP=$(kubectl get svc -n minecraft minecraft -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          echo "âœ… Minecraft Game IP: $GAME_IP"
          
          # Get RCON IP
          RCON_IP=$(kubectl get svc -n minecraft minecraft-rcon -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          echo "âœ… RCON IP: $RCON_IP"
          
          # Get Azure OpenAI credentials
          OPENAI_ENDPOINT=$(az cognitiveservices account show \
            --name mc-demo-dev-openai \
            --resource-group mc-demo-dev-rg \
            --query "properties.endpoint" -o tsv 2>/dev/null || echo "")
          
          OPENAI_KEY=$(az cognitiveservices account keys list \
            --name mc-demo-dev-openai \
            --resource-group mc-demo-dev-rg \
            --query "key1" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$OPENAI_ENDPOINT" ]; then
            echo "âœ… Azure OpenAI Endpoint: $OPENAI_ENDPOINT"
          fi
          
          # Get coordinator identity client ID
          CLIENT_ID=$(az identity show \
            --name mc-demo-dev-coordinator-identity \
            --resource-group mc-demo-dev-dashboard-rg \
            --query clientId -o tsv 2>/dev/null || echo "")
          
          # Build env vars
          ENV_VARS=""
          [ -n "$GAME_IP" ] && ENV_VARS="$ENV_VARS PUBLIC_IP=$GAME_IP"
          [ -n "$RCON_IP" ] && ENV_VARS="$ENV_VARS MINECRAFT_RCON_HOST=$RCON_IP MINECRAFT_RCON_PORT=25575 MINECRAFT_RCON_PASSWORD=worldforge-rcon-2024"
          [ -n "$OPENAI_ENDPOINT" ] && ENV_VARS="$ENV_VARS AZURE_OPENAI_ENDPOINT=$OPENAI_ENDPOINT AZURE_OPENAI_DEPLOYMENT=gpt-4o"
          [ -n "$CLIENT_ID" ] && ENV_VARS="$ENV_VARS AZURE_CLIENT_ID=$CLIENT_ID AKS_RESOURCE_GROUP=mc-demo-dev-rg AKS_CLUSTER_NAME=mc-demo-dev-aks"
          
          # Update coordinator env vars
          if [ -n "$ENV_VARS" ]; then
            az containerapp update \
              --name mc-demo-dev-coordinator \
              --resource-group mc-demo-dev-dashboard-rg \
              --set-env-vars $ENV_VARS
            echo "âœ… Coordinator env vars updated"
          fi
          
          # Update OpenAI secret if key exists
          if [ -n "$OPENAI_KEY" ]; then
            az containerapp secret set \
              --name mc-demo-dev-coordinator \
              --resource-group mc-demo-dev-dashboard-rg \
              --secrets "openai-key=$OPENAI_KEY"
            
            # Restart to pick up secret
            REVISION=$(az containerapp show \
              --name mc-demo-dev-coordinator \
              --resource-group mc-demo-dev-dashboard-rg \
              --query "properties.latestRevisionName" -o tsv)
            
            az containerapp revision restart \
              --name mc-demo-dev-coordinator \
              --resource-group mc-demo-dev-dashboard-rg \
              --revision $REVISION
            
            echo "âœ… OpenAI secret updated and coordinator restarted"
          fi
          
          echo "ðŸŽ‰ Coordinator fully configured!"

