# One-time setup for new forks
# Run this FIRST after adding your Azure credentials and GitHub PAT
# It will automatically configure everything else you need

name: "0. Initial Setup (Run First!)"

on:
  workflow_dispatch:
    inputs:
      confirm_setup:
        description: 'Type "setup" to confirm you want to run initial setup'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  validate:
    name: "Validate Inputs"
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: github.event.inputs.confirm_setup != 'setup'
        run: |
          echo "‚ùå Please type 'setup' in the confirmation field to proceed"
          exit 1

  setup:
    name: "Configure Everything"
    runs-on: ubuntu-latest
    needs: validate
    
    env:
      # Generate unique storage account name from repo (max 24 chars, lowercase alphanumeric only)
      STORAGE_RG_NAME: mc-demo-tfstate-rg
      STORAGE_CONTAINER_NAME: tfstate
    
    steps:
      - uses: actions/checkout@v4

      - name: "Step 1/7: Azure Login (with client secret)"
        run: |
          echo "üîê Logging in to Azure..."
          az login --service-principal \
            --username "${{ secrets.AZURE_CLIENT_ID }}" \
            --password "${{ secrets.AZURE_CLIENT_SECRET }}" \
            --tenant "${{ secrets.AZURE_TENANT_ID }}" \
            --output none
          
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          
          # Verify login
          ACCOUNT=$(az account show --query name -o tsv)
          echo "‚úÖ Logged in to Azure subscription: $ACCOUNT"

      - name: "Step 2/7: Check/Create Federated Credential for OIDC"
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          GITHUB_REPO_FULL: ${{ github.repository }}
        run: |
          echo "üîê Checking OIDC authentication setup..."
          
          # Try to get the app's object ID (requires Azure AD read permissions)
          APP_OBJECT_ID=$(az ad app show --id "$AZURE_CLIENT_ID" --query id -o tsv 2>/dev/null || echo "")
          
          if [ -z "$APP_OBJECT_ID" ]; then
            echo "‚ö†Ô∏è Cannot access Azure AD app registrations (insufficient permissions)"
            echo ""
            echo "This is OK if you already have OIDC configured!"
            echo "The service principal needs 'Application Administrator' role to create federated credentials."
            echo ""
            echo "To verify OIDC works, check if '1. Control Plane' workflow succeeds after this."
            echo "If it fails with auth errors, manually add a federated credential in Azure Portal:"
            echo "  1. Go to Azure Portal ‚Üí App registrations ‚Üí Your app"
            echo "  2. Click 'Certificates & secrets' ‚Üí 'Federated credentials'"
            echo "  3. Add credential for: repo:${GITHUB_REPO_FULL}:ref:refs/heads/main"
            echo ""
            echo "‚úÖ Skipping federated credential setup (may already exist)"
            exit 0
          fi
          
          echo "Found app object ID: $APP_OBJECT_ID"
          
          # Check if federated credential already exists
          EXISTING=$(az ad app federated-credential list --id "$APP_OBJECT_ID" --query "[?name=='github-actions-main'].name" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$EXISTING" ]; then
            echo "‚úÖ Federated credential already exists - skipping"
          else
            echo "Creating federated credential for repo: $GITHUB_REPO_FULL"
            
            # Create federated credential for main branch
            az ad app federated-credential create \
              --id "$APP_OBJECT_ID" \
              --parameters "{
                \"name\": \"github-actions-main\",
                \"issuer\": \"https://token.actions.githubusercontent.com\",
                \"subject\": \"repo:${GITHUB_REPO_FULL}:ref:refs/heads/main\",
                \"audiences\": [\"api://AzureADTokenExchange\"]
              }"
            
            echo "‚úÖ Created federated credential for main branch"
          fi

      - name: "Step 3/7: Bootstrap Terraform State Storage"
        id: bootstrap
        env:
          STORAGE_ACCOUNT_NAME: mcdemodevtfstate
        run: |
          echo "üì¶ Setting up Terraform state storage..."
          
          # Check if resource group already exists
          if az group show --name "$STORAGE_RG_NAME" &>/dev/null; then
            echo "Resource group already exists"
          else
            echo "Creating resource group..."
            az group create --name "$STORAGE_RG_NAME" --location westus3
          fi
          
          # Check if storage account already exists
          if az storage account show --name "$STORAGE_ACCOUNT_NAME" --resource-group "$STORAGE_RG_NAME" &>/dev/null; then
            echo "Storage account already exists"
          else
            echo "Creating storage account: $STORAGE_ACCOUNT_NAME"
            az storage account create \
              --name "$STORAGE_ACCOUNT_NAME" \
              --resource-group "$STORAGE_RG_NAME" \
              --location westus3 \
              --sku Standard_LRS \
              --min-tls-version TLS1_2 \
              --allow-blob-public-access false
          fi
          
          # Get storage account key
          ACCOUNT_KEY=$(az storage account keys list \
            --account-name "$STORAGE_ACCOUNT_NAME" \
            --resource-group "$STORAGE_RG_NAME" \
            --query '[0].value' -o tsv)
          
          # Check if container exists
          if az storage container show --name "$STORAGE_CONTAINER_NAME" --account-name "$STORAGE_ACCOUNT_NAME" --account-key "$ACCOUNT_KEY" &>/dev/null; then
            echo "Container already exists"
          else
            echo "Creating container..."
            az storage container create \
              --name "$STORAGE_CONTAINER_NAME" \
              --account-name "$STORAGE_ACCOUNT_NAME" \
              --account-key "$ACCOUNT_KEY"
          fi
          
          echo "tf_state_key=$ACCOUNT_KEY" >> $GITHUB_OUTPUT
          echo "‚úÖ Terraform state storage ready"

      - name: "Step 4/7: Generate Coordinator API Key"
        id: apikey
        run: |
          echo "üîë Generating secure API key..."
          API_KEY=$(openssl rand -hex 32)
          echo "coordinator_api_key=$API_KEY" >> $GITHUB_OUTPUT
          echo "‚úÖ API key generated"

      - name: "Step 5/7: Save Secrets to Repository"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "üíæ Saving auto-generated secrets..."
          
          # Set TF_STATE_ACCESS_KEY
          gh secret set TF_STATE_ACCESS_KEY --body "${{ steps.bootstrap.outputs.tf_state_key }}"
          echo "‚úÖ TF_STATE_ACCESS_KEY saved"
          
          # Set COORDINATOR_API_KEY
          gh secret set COORDINATOR_API_KEY --body "${{ steps.apikey.outputs.coordinator_api_key }}"
          echo "‚úÖ COORDINATOR_API_KEY saved"
          
          echo ""
          echo "üéâ Secrets configured automatically!"

      - name: "Step 6/7: Deploy Control Plane Infrastructure"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "üöÄ Deploying Control Plane infrastructure..."
          echo ""
          echo "Triggering '1. Control Plane - Deploy/Destroy' workflow..."
          
          gh workflow run permanent-infra.yaml \
            --field action=deploy
          
          echo ""
          echo "‚úÖ Control Plane infrastructure triggered!"
          echo "‚è≥ Waiting 90 seconds for infrastructure to be created..."
          sleep 90

      - name: "Step 7/7: Build and Deploy Container Images"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "üì¶ Building and deploying container images..."
          echo ""
          echo "Triggering 'Auto: Build Containers' workflow..."
          
          gh workflow run dashboard-deploy.yaml
          
          echo ""
          echo "‚úÖ Container build triggered!"
          echo ""
          echo "=============================================="
          echo "   üéâ SETUP COMPLETE!"
          echo "=============================================="
          echo ""
          echo "What's happening now:"
          echo ""
          echo "1. ‚úÖ Setup complete (this workflow)"
          echo "2. üîÑ Control Plane infrastructure (~3-5 min)"
          echo "   ‚Üí Check '1. Control Plane - Deploy/Destroy' workflow"
          echo "3. üîÑ Container images building (~3-5 min)"
          echo "   ‚Üí Check 'Auto: Build Containers' workflow"
          echo ""
          echo "Once both complete (~8-10 min total):"
          echo ""
          echo "4. Find Dashboard URL in Control Plane workflow output"
          echo "5. Visit dashboard and click Admin ‚Üí Deploy to start Minecraft"
          echo ""
          echo "=============================================="
          echo ""
          echo "Repository: ${{ github.repository }}"
          echo "Branch: main"
          echo "Auth: OIDC (secure, no secrets stored)"
          echo ""
