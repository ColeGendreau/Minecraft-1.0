# One-time setup for new forks
# Run this FIRST after adding your Azure credentials and GitHub PAT
# It will automatically configure everything else you need

name: "0. Initial Setup (Run First!)"

on:
  workflow_dispatch:
    inputs:
      confirm_setup:
        description: 'Type "setup" to confirm you want to run initial setup'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

env:
  STORAGE_ACCOUNT_NAME: mcdemodevtfstate
  STORAGE_CONTAINER_NAME: tfstate
  STORAGE_RG_NAME: mc-demo-tfstate-rg

jobs:
  validate:
    name: "Validate Inputs"
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: github.event.inputs.confirm_setup != 'setup'
        run: |
          echo "âŒ Please type 'setup' in the confirmation field to proceed"
          exit 1

  setup:
    name: "Configure Everything"
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - uses: actions/checkout@v4

      - name: "Step 1/6: Azure Login"
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          # Use client secret for initial setup (before OIDC is configured)
          # After setup, workflows use OIDC (no secret needed)
          client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
        continue-on-error: false

      - name: "Step 2/6: Create Federated Credential for OIDC"
        run: |
          echo "ðŸ” Setting up OIDC authentication..."
          
          # Get the app's object ID (different from client ID)
          APP_OBJECT_ID=$(az ad app show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)
          
          # Check if federated credential already exists
          EXISTING=$(az ad app federated-credential list --id $APP_OBJECT_ID --query "[?name=='github-actions-main'].name" -o tsv)
          
          if [ -n "$EXISTING" ]; then
            echo "âœ… Federated credential already exists - skipping"
          else
            # Create federated credential for main branch
            az ad app federated-credential create \
              --id $APP_OBJECT_ID \
              --parameters '{
                "name": "github-actions-main",
                "issuer": "https://token.actions.githubusercontent.com",
                "subject": "repo:${{ github.repository }}:ref:refs/heads/main",
                "audiences": ["api://AzureADTokenExchange"]
              }'
            echo "âœ… Created federated credential for main branch"
          fi

      - name: "Step 3/6: Bootstrap Terraform State Storage"
        id: bootstrap
        run: |
          echo "ðŸ“¦ Setting up Terraform state storage..."
          
          # Check if resource group already exists
          if az group show --name ${{ env.STORAGE_RG_NAME }} &>/dev/null; then
            echo "Resource group already exists"
          else
            echo "Creating resource group..."
            az group create --name ${{ env.STORAGE_RG_NAME }} --location westus3
          fi
          
          # Check if storage account already exists
          if az storage account show --name ${{ env.STORAGE_ACCOUNT_NAME }} --resource-group ${{ env.STORAGE_RG_NAME }} &>/dev/null; then
            echo "Storage account already exists"
          else
            echo "Creating storage account..."
            az storage account create \
              --name ${{ env.STORAGE_ACCOUNT_NAME }} \
              --resource-group ${{ env.STORAGE_RG_NAME }} \
              --location westus3 \
              --sku Standard_LRS \
              --min-tls-version TLS1_2 \
              --allow-blob-public-access false
          fi
          
          # Check if container exists
          ACCOUNT_KEY=$(az storage account keys list --account-name ${{ env.STORAGE_ACCOUNT_NAME }} --resource-group ${{ env.STORAGE_RG_NAME }} --query '[0].value' -o tsv)
          
          if az storage container show --name ${{ env.STORAGE_CONTAINER_NAME }} --account-name ${{ env.STORAGE_ACCOUNT_NAME }} --account-key "$ACCOUNT_KEY" &>/dev/null; then
            echo "Container already exists"
          else
            echo "Creating container..."
            az storage container create \
              --name ${{ env.STORAGE_CONTAINER_NAME }} \
              --account-name ${{ env.STORAGE_ACCOUNT_NAME }} \
              --account-key "$ACCOUNT_KEY"
          fi
          
          echo "tf_state_key=$ACCOUNT_KEY" >> $GITHUB_OUTPUT
          echo "âœ… Terraform state storage ready"

      - name: "Step 4/6: Generate Coordinator API Key"
        id: apikey
        run: |
          echo "ðŸ”‘ Generating secure API key..."
          API_KEY=$(openssl rand -hex 32)
          echo "coordinator_api_key=$API_KEY" >> $GITHUB_OUTPUT
          echo "âœ… API key generated"

      - name: "Step 5/6: Save Secrets to Repository"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "ðŸ’¾ Saving auto-generated secrets..."
          
          # Set TF_STATE_ACCESS_KEY
          gh secret set TF_STATE_ACCESS_KEY --body "${{ steps.bootstrap.outputs.tf_state_key }}"
          echo "âœ… TF_STATE_ACCESS_KEY saved"
          
          # Set COORDINATOR_API_KEY
          gh secret set COORDINATOR_API_KEY --body "${{ steps.apikey.outputs.coordinator_api_key }}"
          echo "âœ… COORDINATOR_API_KEY saved"
          
          echo ""
          echo "ðŸŽ‰ Secrets configured automatically!"

      - name: "Step 6/6: Cleanup Temporary Secret"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "ðŸ§¹ Cleaning up temporary client secret..."
          
          # Delete the client secret from GitHub (no longer needed - OIDC is configured)
          gh secret delete AZURE_CLIENT_SECRET || true
          
          # Note: We can't delete the secret from Azure AD via CLI easily,
          # but the federated credential means the secret is no longer used
          
          echo "âœ… AZURE_CLIENT_SECRET removed from GitHub"
          echo ""
          echo "ðŸ”’ Future workflows will use OIDC (no secrets needed!)"

      - name: "ðŸŽ‰ Setup Complete!"
        run: |
          echo ""
          echo "=============================================="
          echo "   âœ… SETUP COMPLETE!"
          echo "=============================================="
          echo ""
          echo "Your fork is now configured. Next steps:"
          echo ""
          echo "1. Run '1. Control Plane (Dashboard)' workflow"
          echo "   â†’ This deploys the dashboard and coordinator API"
          echo ""
          echo "2. Run '2. Minecraft Server' workflow"
          echo "   â†’ This deploys the Minecraft infrastructure"
          echo ""
          echo "3. Visit your dashboard URL (shown after step 1)"
          echo ""
          echo "=============================================="
          echo ""
          echo "Repository: ${{ github.repository }}"
          echo "Branch: main"
          echo "Auth: OIDC (secure, no secrets stored)"
          echo ""

